# Development Guide

This guide covers setting up a development environment and contributing to claude-code-portal.

## Prerequisites

### Required

- **Rust** (1.78.0 or later)
  ```bash
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
  ```

- **Docker** and **Docker Compose**
  - [Install Docker Desktop](https://docs.docker.com/get-docker/)
  - Or: `brew install docker` (macOS)
  - Or: `sudo apt-get install docker.io docker-compose` (Ubuntu)

- **Claude CLI** (for testing the proxy)
  - Follow [Claude CLI installation](https://docs.anthropic.com/claude/docs/claude-cli)

### Auto-Installed by Scripts

These will be installed automatically when you run `./scripts/dev.sh`:

- **diesel_cli** - Database migration tool
- **trunk** - WASM build tool and dev server
- **wasm32 target** - Rust WebAssembly compilation target

## Quick Start

The fastest way to get a dev environment running:

```bash
# Clone the repository
git clone https://github.com/meawoppl/claude-code-portal.git
cd claude-code-portal

# Start everything (auto-installs dependencies)
./scripts/dev.sh start
```

This will:
1. Start PostgreSQL in Docker
2. Run database migrations
3. Build the frontend
4. Start the backend in dev mode (no OAuth needed)
5. Auto-install diesel/trunk if missing

Then open: **http://localhost:3000/**

You'll be automatically logged in as `testing@testing.local`

### Development Commands

```bash
./scripts/dev.sh status   # Show status of all services
./scripts/dev.sh logs     # Tail backend logs
./scripts/dev.sh stop     # Stop all services
./scripts/dev.sh restart  # Restart all services
./scripts/dev.sh build    # Rebuild frontend only
```

## Manual Setup

For more control over the setup process:

### 1. Install Dependencies

```bash
# Install Rust build tools (one-time setup)
./scripts/install-deps.sh

# Or manually:
rustup target add wasm32-unknown-unknown
cargo install diesel_cli --no-default-features --features postgres
cargo install trunk
```

### 2. Start PostgreSQL

```bash
# Using Docker (recommended for testing)
docker-compose -f docker-compose.test.yml up -d db

# Or use your own PostgreSQL instance
# Make sure it's accessible at localhost:5432
```

### 3. Configure Environment

```bash
# For dev mode, this is sufficient:
export DATABASE_URL="postgresql://claude_portal:dev_password_change_in_production@localhost:5432/claude_portal"
```

### 4. Run Database Migrations

```bash
cd backend
diesel migration run
cd ..
```

### 5. Build and Run

```bash
# Terminal 1: Start backend in dev mode
cargo run -p backend -- --dev-mode

# Terminal 2: Build and serve frontend
cd frontend
trunk serve --open
# Opens browser to http://localhost:8080

# Terminal 3: Run proxy (optional)
cargo run -p proxy -- --backend-url ws://localhost:3000
```

## Project Structure

```
claude-code-portal/
├── Cargo.toml              # Workspace definition
├── Cargo.lock              # Dependency lock file
│
├── shared/                 # Common types (WASM-compatible)
│   ├── Cargo.toml
│   └── src/
│       └── lib.rs          # ProxyMessage, SessionInfo, etc.
│
├── backend/                # Axum server
│   ├── Cargo.toml
│   ├── diesel.toml         # Diesel CLI config
│   ├── migrations/         # Database schemas
│   └── src/
│       ├── main.rs         # Server entry point
│       ├── db.rs           # Database connection pool
│       ├── models.rs       # Diesel models
│       ├── schema.rs       # Generated by Diesel
│       └── handlers/       # HTTP/WebSocket handlers
│
├── frontend/               # Yew WebAssembly app
│   ├── Cargo.toml
│   ├── index.html          # HTML shell
│   ├── styles.css          # Global styles
│   └── src/
│       ├── lib.rs          # App entry point
│       ├── components/     # Reusable UI components
│       └── pages/          # Page components
│
├── proxy/                  # CLI wrapper
│   ├── Cargo.toml
│   └── src/
│       ├── main.rs         # Proxy entry point
│       ├── auth.rs         # Device flow client
│       └── config.rs       # Credential storage
│
├── scripts/                # Helper scripts
│   ├── dev.sh              # Development environment
│   ├── install-deps.sh     # Install build tools
│   ├── db-shell.sh         # Open database shell
│   └── clean.sh            # Clean up everything
│
└── docs/                   # Documentation
```

## Building Individual Components

```bash
# Build everything
cargo build --workspace

# Build specific crate
cargo build -p backend
cargo build -p frontend
cargo build -p proxy

# Build for release (optimized)
cargo build --workspace --release

# Build frontend (WASM)
cd frontend
trunk build --release
```

## Running Tests

```bash
# Run all Rust tests
cargo test --workspace

# Test backend only
cargo test -p backend

# Check code without building
cargo check --workspace

# Lint and format
cargo clippy --workspace -- -D warnings
cargo fmt --check
```

## Database Management

```bash
# Run migrations
cd backend
diesel migration run

# Revert last migration
diesel migration revert

# Create new migration
diesel migration generate add_new_feature

# Reset database (caution!)
diesel database reset

# Open psql shell
./scripts/db-shell.sh
```

### Migration Naming Convention

All migrations must follow this naming format:
```
YYYY-MM-DD-HHMMSS_snake_case_description
```

Examples:
- `2026-01-15-143022_add_users_table`
- `2026-01-16-091500_add_index_to_sessions`

This is enforced by CI.

## Development Workflow

**Typical workflow for adding a feature:**

1. **Create a branch**
   ```bash
   git checkout -b feature/new-feature
   ```

2. **Make changes**
   - Modify code in appropriate crate
   - If changing shared protocol, update `shared/src/lib.rs`
   - If adding database fields, create migration

3. **Test locally**
   ```bash
   ./scripts/dev.sh start
   # Verify changes work at http://localhost:3000/
   ./scripts/dev.sh stop
   ```

4. **Run checks**
   ```bash
   cargo test --workspace
   cargo clippy --workspace
   cargo fmt
   ```

5. **Commit and push**
   ```bash
   git add .
   git commit -m "Add new feature"
   git push origin feature/new-feature
   ```

## Hot Reload Development

For rapid iteration:

```bash
# Terminal 1: Backend with auto-reload
cargo watch -x 'run -p backend -- --dev-mode'

# Terminal 2: Frontend with hot reload
cd frontend
trunk serve

# Terminal 3: Proxy
cargo run -p proxy
```

## Architecture Notes

### WASM Compatibility

The `shared/` crate must be WASM-compatible. Rules for `shared/Cargo.toml`:
- Use `serde`, `serde_json` with default features
- Use `uuid` with `js` feature (for WASM random)
- Use `chrono` with `wasmbind` feature
- NO `tokio` (has native networking)
- NO `diesel` (native DB)
- NO `std::fs`, `std::net`, or other native-only APIs

### Unified AppState Pattern

All backend handlers use `State<Arc<AppState>>`:

```rust
pub async fn handler(
    State(app_state): State<Arc<AppState>>,
    // ... other extractors
) -> Result<impl IntoResponse, StatusCode> {
    let pool = &app_state.db_pool;
    // ...
}
```

### Database Query Patterns

Always qualify column references to avoid ambiguity:

```rust
// Good - explicit table reference
use schema::sessions;
sessions::table.filter(sessions::id.eq(some_id))

// Bad - ambiguous if multiple tables have same column
use schema::sessions::dsl::*;
sessions.filter(id.eq(some_id))
```

## Troubleshooting

See [TROUBLESHOOTING.md](../TROUBLESHOOTING.md) for common issues and solutions.

### Quick Fixes

**Backend won't start:**
```bash
# Check database connection
psql $DATABASE_URL

# Check if port 3000 is in use
lsof -i :3000

# Check logs
tail -f /tmp/claude-code-portal-backend.log
```

**Frontend won't build:**
```bash
# Ensure wasm target is installed
rustup target add wasm32-unknown-unknown

# Clean and rebuild
cd frontend
trunk clean
trunk build
```

**"diesel CLI not found":**
```bash
# Update Rust first
rustup update stable

# Install diesel
cargo install diesel_cli --no-default-features --features postgres
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Run `cargo test` and `cargo clippy`
6. Submit a pull request

Please open an issue first to discuss major changes.
